name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches-ignore:
      - env-prod

concurrency:
  group: continuous-integration-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  lints:
    name: Lints
    uses: ./.github/workflows/lints.yml
    with:
      checkout_ref: ${{ github.event.pull_request.head.ref }}

  tests:
    name: Tests
    uses: ./.github/workflows/tests.yml
  
  commentary:
    name: Commentary
    needs: [lints, tests]
    if: >-
      always() &&
      github.event.pull_request.user.login != 'dependabot[bot]'
    uses: ./.github/workflows/commentary.yml
    secrets: inherit
    with:
      lint_frontend_status: ${{ needs.lints.outputs.lint_frontend_status }}
      lint_frontend_log: ${{ needs.lints.outputs.lint_frontend_log }}
      lint_backend_status: ${{ needs.lints.outputs.lint_backend_status }}
      lint_backend_log: ${{ needs.lints.outputs.lint_backend_log }}
      test_frontend_status: ${{ needs.tests.outputs.test_frontend_status }}
      test_frontend_log: ${{ needs.tests.outputs.test_frontend_log }}
      test_backend_status: ${{ needs.tests.outputs.test_backend_status }}
      test_backend_log: ${{ needs.tests.outputs.test_backend_log }}

  auto-merge:
    name: Auto Merge
    needs: [lints, tests]
    if: >-
      github.event.pull_request.user.login == 'dependabot[bot]' &&
      needs.lints.result == 'success' &&
      needs.tests.result == 'success'
    uses: ./.github/workflows/auto_merge.yml
    permissions:
      contents: write
      pull-requests: write
      issues: write
      security-events: read
