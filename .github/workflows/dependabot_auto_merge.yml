name: Dependabot Auto Merge

on:
  workflow_call:
    secrets:
      OPENAI_API_KEY:
        required: false
      OPENAI_PROJECT_ID:
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  dependabot-auto-merge:
    name: Dependabot Auto Merge
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Summarize major update with ChatGPT
        id: major_summary
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
          PACKAGE_NAME: ${{ steps.metadata.outputs.dependency-names }}
          OLD_VERSION: ${{ steps.metadata.outputs.previous-version }}
          NEW_VERSION: ${{ steps.metadata.outputs.new-version }}
          ECOSYSTEM: ${{ steps.metadata.outputs.package-ecosystem }}
          SCOPE: ${{ steps.metadata.outputs.dependency-type }}
        run: |
          if [ -z "$OPENAI_API_KEY" ] || [ -z "$OPENAI_PROJECT_ID" ]; then
            echo "summary=Missing OpenAI secrets; skipping summary." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PROMPT="Dependency Update Summary (Major)\n\nPackage: ${PACKAGE_NAME}\nFrom: ${OLD_VERSION}\nTo: ${NEW_VERSION}\nEcosystem: ${ECOSYSTEM}\nScope: ${SCOPE}\n\nProvide:\n- High-level changes (focus on breaking changes)\n- Required code/config changes (Yes/No + details)\n- Risk level (Low/Medium/High) with rationale\n- Test coverage confidence\n- Migration guide availability\n- Recommendation (merge later / do not merge / needs investigation)\n- TL;DR"
          jq -n \
            --arg prompt "$PROMPT" \
            '
            {
              model: "gpt-5.1",
              temperature: 0.2,
              messages: [
                { "role": "system", "content": "You summarize dependency major updates for maintainers." },
                { "role": "user", "content": $prompt }
              ]
            }
            ' > body.json

          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Project: $OPENAI_PROJECT_ID" \
            --data @body.json)

          SUMMARY=$(echo "$RESPONSE" | jq -r '
            if .choices and .choices[0].message and .choices[0].message.content then
              .choices[0].message.content
            elif .error and .error.message then
              "OpenAI API error: " + .error.message
            else
              "OpenAI did not return a summary."
            end
          ')

          {
            echo 'summary<<EOF'
            printf '%s\n' "$SUMMARY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Post major update summary to PR
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SUMMARY_BODY: ${{ steps.major_summary.outputs.summary }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ -z "$SUMMARY_BODY" ]; then
            echo "No summary to post."
            exit 0
          fi

          jq -n --arg body "$SUMMARY_BODY" '{body: $body}' > comment.json

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments" \
            -d @comment.json

      - name: Auto-approve Dependabot PR
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.issue.number;
            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number,
              event: 'APPROVE',
            });

      - name: Enable auto-merge
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.issue.number;
            const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            let pr;
            for (let attempt = 1; attempt <= 6; attempt += 1) {
              const { data } = await github.rest.pulls.get({ owner, repo, pull_number });
              pr = data;
              core.info(`mergeable_state=${pr.mergeable_state} mergeable=${pr.mergeable}`);
              if (pr.mergeable_state === 'clean' && pr.mergeable !== false) {
                break;
              }
              if (attempt < 6) {
                await wait(10000);
              }
            }

            if (!pr || pr.mergeable === false) {
              core.warning('PR is not mergeable; skipping auto-merge handling.');
              return;
            }

            if (pr.mergeable_state === 'clean') {
              if (pr.merged) {
                core.info('PR is already merged; skipping.');
                return;
              }
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number,
                merge_method: 'merge',
              });
              core.info('PR merged directly because it is clean.');
              return;
            }

            if (pr.mergeable_state === 'unstable') {
              core.info('PR checks are still running; enabling auto-merge for when checks pass.');
            }

            const mutation = `
              mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: $mergeMethod
                }) {
                  pullRequest {
                    number
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `;
            await github.graphql(mutation, {
              pullRequestId: pr.node_id,
              mergeMethod: "MERGE",
            });
