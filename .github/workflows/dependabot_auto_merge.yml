name: Dependabot Auto Merge

on:
  workflow_call:
    inputs:
      pr_number:
        required: false
        type: number
      pr_author:
        required: false
        type: string
    secrets:
      OPENAI_API_KEY:
        required: false
      OPENAI_PROJECT_ID:
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  dependabot-auto-merge:
    name: Dependabot Auto Merge
    if: github.event.pull_request.user.login == 'dependabot[bot]' || inputs.pr_author == 'dependabot[bot]'
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Summarize major update with ChatGPT
        id: major_summary
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
          PACKAGE_NAME: ${{ steps.metadata.outputs.dependency-names }}
          OLD_VERSION: ${{ steps.metadata.outputs.previous-version }}
          NEW_VERSION: ${{ steps.metadata.outputs.new-version }}
          ECOSYSTEM: ${{ steps.metadata.outputs.package-ecosystem }}
          SCOPE: ${{ steps.metadata.outputs.dependency-type }}
        run: |
          if [ -z "$OPENAI_API_KEY" ] || [ -z "$OPENAI_PROJECT_ID" ]; then
            echo "summary=Missing OpenAI secrets; skipping summary." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PROMPT="Dependency Update Summary (Major)\n\nPackage: ${PACKAGE_NAME}\nFrom: ${OLD_VERSION}\nTo: ${NEW_VERSION}\nEcosystem: ${ECOSYSTEM}\nScope: ${SCOPE}\n\nProvide:\n- High-level changes (focus on breaking changes)\n- Required code/config changes (Yes/No + details)\n- Risk level (Low/Medium/High) with rationale\n- Test coverage confidence\n- Migration guide availability\n- Recommendation (merge later / do not merge / needs investigation)\n- TL;DR"
          jq -n \
            --arg prompt "$PROMPT" \
            '
            {
              model: "gpt-5.1",
              temperature: 0.2,
              messages: [
                { "role": "system", "content": "You summarize dependency major updates for maintainers." },
                { "role": "user", "content": $prompt }
              ]
            }
            ' > body.json

          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Project: $OPENAI_PROJECT_ID" \
            --data @body.json)

          SUMMARY=$(echo "$RESPONSE" | jq -r '
            if .choices and .choices[0].message and .choices[0].message.content then
              .choices[0].message.content
            elif .error and .error.message then
              "OpenAI API error: " + .error.message
            else
              "OpenAI did not return a summary."
            end
          ')

          {
            echo 'summary<<EOF'
            printf '%s\n' "$SUMMARY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Post major update summary to PR
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        uses: actions/github-script@v8
        env:
          SUMMARY_BODY: ${{ steps.major_summary.outputs.summary }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = Number(process.env.PR_NUMBER);
            const summaryBody = (process.env.SUMMARY_BODY || '').trim();

            if (!pull_number) {
              core.warning('PR number is not available; skipping summary comment.');
              return;
            }

            if (!summaryBody) {
              core.info('No summary to post.');
              return;
            }

            const marker = '<!-- dependabot-major-summary -->';
            const body = `${summaryBody}\n\n${marker}`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pull_number,
              per_page: 100,
            });

            const existing = comments.find(
              (comment) =>
                comment.user &&
                comment.user.login === 'github-actions[bot]' &&
                typeof comment.body === 'string' &&
                comment.body.includes(marker)
            );

            if (existing) {
              const cleanedExisting = existing.body.replace(marker, '').trim();
              if (cleanedExisting === summaryBody) {
                core.info('Summary comment already up to date; skipping.');
                return;
              }

              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
              core.info('Summary comment updated.');
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body,
            });
            core.info('Summary comment posted.');

      - name: Auto-approve Dependabot PR
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = Number(process.env.PR_NUMBER);

            if (!pull_number) {
              core.warning('PR number is not available; skipping auto-approve.');
              return;
            }

            const reviews = await github.paginate(github.rest.pulls.listReviews, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const alreadyApproved = reviews.some(
              (review) =>
                review.user &&
                review.user.login === 'github-actions[bot]' &&
                review.state === 'APPROVED'
            );

            if (alreadyApproved) {
              core.info('PR already approved by github-actions[bot]; skipping.');
              return;
            }

            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number,
              event: 'APPROVE',
            });

      - name: Enable auto-merge
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = Number(process.env.PR_NUMBER);
            const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            if (!pull_number) {
              core.warning('PR number is not available; skipping auto-merge.');
              return;
            }

            let pr;
            const maxAttempts = 3;
            for (let attempt = 1; attempt <= maxAttempts; attempt += 1) {
              const { data } = await github.rest.pulls.get({ owner, repo, pull_number });
              pr = data;
              if (pr.mergeable !== null && pr.mergeable_state && pr.mergeable_state !== 'unknown') {
                break;
              }
              if (attempt < maxAttempts) {
                await wait(5000);
              }
            }

            if (!pr) {
              core.warning('PR data not available; skipping auto-merge handling.');
              return;
            }

            if (pr.merged) {
              core.info('PR is already merged; skipping.');
              return;
            }

            if (pr.draft) {
              core.warning('PR is a draft; skipping.');
              return;
            }

            if (pr.mergeable === false || pr.mergeable_state === 'dirty') {
              core.warning('PR has merge conflicts; skipping.');
              return;
            }

            if (pr.auto_merge) {
              core.info('Auto-merge is already enabled; skipping.');
              return;
            }

            if (pr.mergeable == null || pr.mergeable_state === 'unknown') {
              core.warning('PR mergeability is still being calculated; skipping for now.');
              return;
            }

            const mutation = `
              mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: $mergeMethod
                }) {
                  pullRequest {
                    number
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `;
            try {
              await github.graphql(mutation, {
                pullRequestId: pr.node_id,
                mergeMethod: "MERGE",
              });
              core.info('Auto-merge enabled.');
            } catch (error) {
              const message = error?.message || 'Unknown error';
              core.warning(`Auto-merge not enabled: ${message}`);
            }
