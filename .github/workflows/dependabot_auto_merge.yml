name: Auto Merge

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  dependabot-auto-merge:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Resolve pull request
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pullRequests = context.payload.workflow_run.pull_requests;
            if (!pullRequests || pullRequests.length === 0) {
              core.setFailed('No pull request found for this workflow run.');
              return;
            }
            const pull_number = pullRequests[0].number;
            const { owner, repo } = context.repo;
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number,
            });
            core.setOutput('number', pull_number.toString());
            core.setOutput('author', pr.data.user.login);

      - name: Build Dependabot event payload
        id: event
        if: steps.pr.outputs.author == 'dependabot[bot]'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const pull_number = Number('${{ steps.pr.outputs.number }}');
            const { owner, repo } = context.repo;
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number,
            });
            const eventPath = path.join(process.env.RUNNER_TEMP, 'dependabot-event.json');
            fs.writeFileSync(eventPath, JSON.stringify({ pull_request: pr.data }));
            core.setOutput('path', eventPath);

      - name: Fetch Dependabot metadata
        id: metadata
        if: steps.pr.outputs.author == 'dependabot[bot]'
        uses: dependabot/fetch-metadata@v2
        env:
          GITHUB_EVENT_PATH: ${{ steps.event.outputs.path }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-approve Dependabot PR
        if: steps.pr.outputs.author == 'dependabot[bot]' && (steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor')
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = Number('${{ steps.pr.outputs.number }}');
            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number,
              event: 'APPROVE',
            });

      - name: Enable auto-merge
        if: steps.pr.outputs.author == 'dependabot[bot]' && (steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor')
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = Number('${{ steps.pr.outputs.number }}');
            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $number) {
                    id
                  }
                }
              }
            `;
            const data = await github.graphql(query, {
              owner,
              repo,
              number: pull_number,
            });
            const mutation = `
              mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: $mergeMethod
                }) {
                  pullRequest {
                    number
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `;
            await github.graphql(mutation, {
              pullRequestId: data.repository.pullRequest.id,
              mergeMethod: "MERGE",
            });
