name: PR Summary

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: pr-summary-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: ChatGPT Summary
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get PR diff
        run: |
          # Get the base and head SHAs for the PR
          BASE_SHA=$(jq -r .pull_request.base.sha "$GITHUB_EVENT_PATH")
          HEAD_SHA=$(jq -r .pull_request.head.sha "$GITHUB_EVENT_PATH")

          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"

          # Get unified diff between base and head
          git diff --unified=3 "$BASE_SHA" "$HEAD_SHA" > pr.diff

          # Truncate if it's huge so we don't blow up token limits
          MAX_BYTES=45000
          ACTUAL_BYTES=$(wc -c < pr.diff || echo 0)
          if [ "$ACTUAL_BYTES" -gt "$MAX_BYTES" ]; then
            head -c "$MAX_BYTES" pr.diff > pr_truncated.diff
            echo "::warning::Diff was too large ($ACTUAL_BYTES bytes). Truncated to $MAX_BYTES bytes."
            mv pr_truncated.diff pr.diff
          fi

          echo "Diff size:"
          wc -c pr.diff

      - name: Call OpenAI
        id: openai
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
        with:
          script: |
            const fs = require('fs');

            const apiKey = process.env.OPENAI_API_KEY;
            const projectId = process.env.OPENAI_PROJECT_ID;

            if (!apiKey) {
              core.setOutput('summary', 'Missing OPENAI_API_KEY secret.');
              return;
            }

            if (!projectId) {
              core.setOutput('summary', 'Missing OPENAI_PROJECT_ID secret.');
              return;
            }

            const diffContent = fs.readFileSync('pr.diff', 'utf8');
            const prompt = [
              "You are a PR summarizer for the Notoli project (Backend: Django; Frontend: React + MUI; Docker; GitHub Actions).",
              "Produce a high-level, human-readable digest of what changed and why it matters.",
              "Focus on intent, scope, behavior changes, and impact.",
              "Do NOT do a code review.",
              "Do NOT list line-by-line or file-by-file changes.",
              "Do NOT restate the diff.",
              "Be concise.",
              "If the diff is truncated, explicitly note that the summary may be incomplete.",
              "Your response MUST use the following exact sections, in order, each containing bullet points (or '(none)' if empty):",
              "## Summary (what & why):",
              "## Scope (what areas are affected):",
              "## Behavior Changes (user-visible or API-visible):",
              "## Risk & Impact (what could break / who is affected):",
              "## Suggested Verification (quick checks):",
              "## Follow-ups (nice-to-do, not required for merge):",
              "Here is the diff:",
              diffContent
            ].join(' ');

            const body = {
              model: "gpt-5.1",
              temperature: 0.3,
              messages: [
                { role: "system", content: "You are an experienced PR summarizer helping on GitHub pull requests." },
                { role: "user", content: prompt }
              ]
            };

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'OpenAI-Project': projectId
              },
              body: JSON.stringify(body)
            });

            const data = await response.json().catch(() => ({}));
            core.info(`OpenAI response status: ${response.status}`);

            let summary = 'OpenAI did not return a summary.';
            if (data?.choices?.[0]?.message?.content) {
              summary = data.choices[0].message.content;
            } else if (data?.error?.message) {
              summary = `OpenAI API error: ${data.error.message}`;
            }

            core.setOutput('summary', summary);

      - name: Update PR Description
        uses: actions/github-script@v7
        env:
          SUMMARY_BODY: ${{ steps.openai.outputs.summary }}
        with:
          script: |
            const fs = require('fs');

            const event = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'));
            const prNumber = event.pull_request.number;
            const summary = process.env.SUMMARY_BODY || '';

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: summary
            });

