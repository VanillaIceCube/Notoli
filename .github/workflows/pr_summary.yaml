name: PR Summary

on:
  workflow_run:
    workflows: ["Lint"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: ChatGPT Summary
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Ensure this was a PR run
        id: prcheck
        shell: bash
        run: |
          # workflow_run payload includes PRs only when the triggering workflow was on pull_request
          PR_COUNT=$(jq '.workflow_run.pull_requests | length' "$GITHUB_EVENT_PATH")
          echo "pr_count=$PR_COUNT" >> "$GITHUB_OUTPUT"
          if [ "$PR_COUNT" -eq 0 ]; then
            echo "No PR associated with this run; exiting."
            exit 0
          fi

      - name: Checkout PR head SHA
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Get PR metadata
        id: prmeta
        shell: bash
        run: |
          PR_NUMBER=$(jq -r '.workflow_run.pull_requests[0].number' "$GITHUB_EVENT_PATH")
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

          BASE_SHA=$(jq -r '.workflow_run.pull_requests[0].base.sha' "$GITHUB_EVENT_PATH")
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"

          echo "base_sha=$BASE_SHA" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"

      - name: Get PR diff
        shell: bash
        run: |
          BASE_SHA="${{ steps.prmeta.outputs.base_sha }}"
          HEAD_SHA="${{ steps.prmeta.outputs.head_sha }}"

          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"

          git diff --unified=3 "$BASE_SHA" "$HEAD_SHA" > pr.diff

          MAX_BYTES=45000
          ACTUAL_BYTES=$(wc -c < pr.diff || echo 0)
          if [ "$ACTUAL_BYTES" -gt "$MAX_BYTES" ]; then
            head -c "$MAX_BYTES" pr.diff > pr_truncated.diff
            echo "::warning::Diff was too large ($ACTUAL_BYTES bytes). Truncated to $MAX_BYTES bytes."
            mv pr_truncated.diff pr.diff
          fi

          echo "Diff size:"
          wc -c pr.diff

      - name: Call OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
        shell: bash
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "summary=Missing OPENAI_API_KEY secret." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "$OPENAI_PROJECT_ID" ]; then
            echo "summary=Missing OPENAI_PROJECT_ID secret." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          DIFF_CONTENT=$(cat pr.diff)

          PROMPT="You are a PR summarizer for the Notoli project (Backend: Django; Frontend: React + MUI; Docker; GitHub Actions). Produce a high-level, human-readable digest of what changed and why it matters. Focus on intent, scope, behavior changes, and impact. Do NOT do a code review. Do NOT list line-by-line or file-by-file changes. Do NOT restate the diff. Be concise. If the diff is truncated, explicitly note that the summary may be incomplete. Your response MUST use the following exact sections, in order, each containing bullet points (or '(none)' if empty): ## ðŸ“Œ Summary (what & why): ## ðŸ“‚ Scope (what areas are affected): ## ðŸ”„ Behavior Changes (user-visible or API-visible): ## âš ï¸ Risk & Impact (what could break / who is affected): ## ðŸ”Ž Suggested Verification (quick checks): ## âž• Follow-ups (nice-to-do, not required for merge): Here is the diff: ${DIFF_CONTENT}"

          jq -n \
            --arg prompt "$PROMPT" \
            '
            {
              model: "gpt-5.1",
              temperature: 0.3,
              messages: [
                { "role": "system", "content": "You are an experienced PR summarizer helping on GitHub pull requests." },
                { "role": "user", "content": $prompt }
              ]
            }
            ' > body.json

          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Project: $OPENAI_PROJECT_ID" \
            --data @body.json)

          SUMMARY=$(echo "$RESPONSE" | jq -r '
            if .choices and .choices[0].message and .choices[0].message.content then
              .choices[0].message.content
            elif .error and .error.message then
              "OpenAI API error: " + .error.message
            else
              "OpenAI did not return a summary."
            end
          ')

          {
            echo 'summary<<EOF'
            printf '%s\n' "$SUMMARY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Update PR Description
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SUMMARY_BODY: ${{ steps.openai.outputs.summary }}
        shell: bash
        run: |
          PR_NUMBER="${{ steps.prmeta.outputs.pr_number }}"
          jq -n --arg body "$SUMMARY_BODY" '{body: $body}' > update.json

          curl -s -X PATCH \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${PR_NUMBER}" \
            -d @update.json
