name: PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: ChatGPT Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        run: |
          # Get the base and head SHAs for the PR
          BASE_SHA=$(jq -r .pull_request.base.sha "$GITHUB_EVENT_PATH")
          HEAD_SHA=$(jq -r .pull_request.head.sha "$GITHUB_EVENT_PATH")

          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"

          # Get unified diff between base and head
          git diff --unified=3 "$BASE_SHA" "$HEAD_SHA" > pr.diff

          # Truncate if it's huge so we don't blow up token limits
          MAX_BYTES=45000
          ACTUAL_BYTES=$(wc -c < pr.diff || echo 0)
          if [ "$ACTUAL_BYTES" -gt "$MAX_BYTES" ]; then
            head -c "$MAX_BYTES" pr.diff > pr_truncated.diff
            echo "::warning::Diff was too large ($ACTUAL_BYTES bytes). Truncated to $MAX_BYTES bytes."
            mv pr_truncated.diff pr.diff
          fi

          echo "Diff size:"
          wc -c pr.diff

      - name: Call OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY is not set. Add it as a repository secret."
            echo "review=OpenAI API key is missing. Set the OPENAI_API_KEY secret in your repo settings." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Flatten the diff into a single line (avoid giant newlines, tokens)
          DIFF_CONTENT=$(tr '\n' ' ' < pr.diff)

          # Build prompt as a normal shell string (no JSON yet)
          PROMPT="You are a senior engineer reviewing a pull request for the Notoli project. The stack is: Backend: Django; Frontend: React + Material UI; Environment Management: Conda; Deployment: Docker; CI/CD & Workflows: GitHub Actions. Provide concise, actionable feedback about potential bugs or logic issues, confusing or hard-to-maintain code, and performance or security concerns. Don't gas me up. Be brutally honest. Here is the diff: ${DIFF_CONTENT}"

          # Use jq to build a valid JSON body so we don't have to manually escape anything
          jq -n --arg prompt "$PROMPT" '
            {
              model: "gpt-4.1-mini",
              temperature: 0.3,
              messages: [
                {
                  role: "system",
                  content: "You are an experienced code reviewer helping on GitHub pull requests."
                },
                {
                  role: "user",
                  content: $prompt
                }
              ]
            }
          ' > body.json

          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer '"$OPENAI_API_KEY"'" \
            --data @body.json)

          echo "Raw response:"
          echo "$RESPONSE"

          REVIEW=$(echo "$RESPONSE" | jq -r '
            if .choices and .choices[0].message and .choices[0].message.content then
              .choices[0].message.content
            elif .error and .error.message then
              "OpenAI API error: " + .error.message
            else
              "OpenAI did not return a review. Check the workflow logs for details."
            end
          ')

          REVIEW_ESCAPED=$(printf '%s\n' "$REVIEW" | sed 's/%/%25/g; s/\n/%0A/g; s/\r/%0D/g')
          echo "review=$REVIEW_ESCAPED" >> "$GITHUB_OUTPUT"

      - name: Leave Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(jq -r .pull_request.number "$GITHUB_EVENT_PATH")
          REVIEW_BODY="${{ steps.openai.outputs.review }}"

          jq -n --arg body "$REVIEW_BODY" '{body: $body}' > comment.json

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments" \
            -d @comment.json
