name: PR Review

on:
  workflow_run:
    workflows: ["Lint"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: ChatGPT Review
    # Only run if the Lint workflow succeeded *and* it was triggered by a PR
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR commit
        uses: actions/checkout@v4
        with:
          # Check out the same commit that Lint ran on
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Get PR diff
        run: |
          EVENT_PATH="$GITHUB_EVENT_PATH"

          # For workflow_run, the PR info is under .workflow_run.pull_requests[0]
          BASE_SHA=$(jq -r '.workflow_run.pull_requests[0].base.sha' "$EVENT_PATH")
          HEAD_SHA=$(jq -r '.workflow_run.head_sha' "$EVENT_PATH")
          PR_NUMBER=$(jq -r '.workflow_run.pull_requests[0].number' "$EVENT_PATH")

          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"
          echo "PR:   $PR_NUMBER"

          # Make PR number available to later steps
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"

          # Get unified diff between base and head
          git diff --unified=3 "$BASE_SHA" "$HEAD_SHA" > pr.diff

          # Truncate if it's huge so we don't blow up token limits
          MAX_BYTES=45000
          ACTUAL_BYTES=$(wc -c < pr.diff || echo 0)
          if [ "$ACTUAL_BYTES" -gt "$MAX_BYTES" ]; then
            head -c "$MAX_BYTES" pr.diff > pr_truncated.diff
            echo "::warning::Diff was too large ($ACTUAL_BYTES bytes). Truncated to $MAX_BYTES bytes."
            mv pr_truncated.diff pr.diff
          fi

          echo "Diff size:"
          wc -c pr.diff

      - name: Call OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "review=Missing OPENAI_API_KEY secret." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "$OPENAI_PROJECT_ID" ]; then
            echo "review=Missing OPENAI_PROJECT_ID secret." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Keep diff formatting (no flattening)
          DIFF_CONTENT=$(cat pr.diff)

          # Build prompt
          PROMPT="You are a senior engineer reviewing a pull request for the Notoli project. The tech stack is: Backend: Django; Frontend: React + Material UI; Environment: Conda; Deployment: Docker; CI/CD: GitHub Actions. Review the diff and give concise, brutally honest, actionable feedback. Your response MUST use the following exact sections, in order, each containing bullet points (or '(none)' if empty): ## ðŸ”´ Critical Issues (must fix before merge): ... ## ðŸŸ  Major Issues (should fix): ... ## ðŸŸ¡ Minor Issues (nice to fix): ... ## ðŸ”µ Suggestions & Improvements (optional): ... ## ðŸŸ£ Observations (non-actionable): ... Do NOT include anything outside these sections and do NOT restate the diff. Here is the diff: ${DIFF_CONTENT}"

          # Build JSON safely
          jq -n \
            --arg prompt "$PROMPT" \
            '
            {
              model: "gpt-5.1",
              temperature: 0.3,
              messages: [
                { "role": "system", "content": "You are an experienced code reviewer helping on GitHub pull requests." },
                { "role": "user", "content": $prompt }
              ]
            }
            ' > body.json

          # Make API request (project is passed via header)
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Project: $OPENAI_PROJECT_ID" \
            --data @body.json)

          echo "Raw response:"
          echo "$RESPONSE"

          # Extract review text or error
          REVIEW=$(echo "$RESPONSE" | jq -r '
            if .choices and .choices[0].message and .choices[0].message.content then
              .choices[0].message.content
            elif .error and .error.message then
              "OpenAI API error: " + .error.message
            else
              "OpenAI did not return a review."
            end
          ')

          echo "Review content:"
          echo "$REVIEW"

          # Write multi-line output for GitHub Actions
          {
            echo 'review<<EOF'
            printf '%s\n' "$REVIEW"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Leave Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REVIEW_BODY: ${{ steps.openai.outputs.review }}
        run: |
          # PR_NUMBER comes from the previous step via GITHUB_ENV
          : "${PR_NUMBER:?PR_NUMBER not set}"

          # Build the comment JSON safely with jq
          jq -n --arg body "$REVIEW_BODY" '{body: $body}' > comment.json

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments" \
            -d @comment.json
