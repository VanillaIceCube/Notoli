name: Tests

on:
  workflow_call:

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend-tests:
    name: Frontend Tests (React)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v6

      - name: Read Node version (package.json engines)
        id: node-version
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          data = json.loads(Path("package.json").read_text(encoding="utf-8"))
          version = (data.get("engines") or {}).get("node")
          if not version:
              raise SystemExit("Missing engines.node in frontend/package.json")
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"node_version={version}\n")
          PY

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.node-version.outputs.node_version }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install frontend dependencies
        run: npm ci

      - name: Run frontend tests
        env:
          CI: true
        run: npm test -- --watchAll=false --verbose --runInBand

  backend-tests:
    name: Backend Tests (Django)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v6

      - name: Read Python version (environment.yml)
        id: python-version
        run: |
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          text = Path("environment.yml").read_text(encoding="utf-8")
          match = re.search(r"^\s*-\s*python=([0-9.]+)\s*$", text, re.M)
          if not match:
              raise SystemExit("Missing python pin in backend/environment.yml")
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"python_version={match.group(1)}\n")
          PY

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ steps.python-version.outputs.python_version }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        run: pip install -r requirements.txt

      - name: Run backend tests
        run: python manage.py test --verbosity=2
