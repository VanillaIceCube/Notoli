name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_run:
    workflows: ["Lint Auto Fixes"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      checkout_ref:
        description: "Branch or ref to check out for auto-fix commits."
        required: false
        type: string

concurrency:
  group: continuous-integration-${{ github.event.pull_request.number || github.event.workflow_run.pull_requests[0].number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  resolve-ref:
    name: Resolve Checkout Ref
    runs-on: ubuntu-latest
    outputs:
      checkout_ref: ${{ steps.resolve.outputs.checkout_ref }}
    steps:
      - name: Resolve checkout ref
        id: resolve
        uses: actions/github-script@v7
        with:
          script: |
            let ref;

            if (context.eventName === 'workflow_run') {
              const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
              if (prNumber) {
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                });
                ref = pr.head.sha;
              } else {
                ref = context.payload.workflow_run.head_sha;
              }
            } else if (context.eventName === 'pull_request') {
              ref = context.payload.pull_request.head.sha;
            } else {
              ref = context.payload.inputs?.checkout_ref || context.ref_name;
            }

            core.setOutput('checkout_ref', ref);

  lints:
    name: Lints
    needs: resolve-ref
    uses: ./.github/workflows/lints.yaml
    with:
      checkout_ref: ${{ needs.resolve-ref.outputs.checkout_ref }}
      auto_fix: false
      run_checks: true

  tests:
    name: Tests
    needs: resolve-ref
    uses: ./.github/workflows/tests.yaml
    with:
      checkout_ref: ${{ needs.resolve-ref.outputs.checkout_ref }}
  
  pr-summary:
    name: Commentary
    needs: [lints, tests]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/commentary.yaml
    secrets: inherit

  auto-merge:
    name: Auto Merge
    needs: [lints, tests]
    if: github.event_name == 'pull_request' && github.event.pull_request.user.login == 'dependabot[bot]' && needs.lints.result == 'success' && needs.tests.result == 'success'
    uses: ./.github/workflows/auto_merge.yml
    permissions:
      contents: write
      pull-requests: write
      issues: write
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
