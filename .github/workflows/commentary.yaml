name: Commentary

on:
  workflow_call:
  issue_comment:
    types: [created]

concurrency:
  group: pr-summary-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-review:
    name: PR Summary
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get PR diff
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"

          # Get unified diff between base and head
          git diff --unified=3 "$BASE_SHA" "$HEAD_SHA" > pr.diff

          # Truncate if it's huge so we don't blow up token limits
          MAX_BYTES=45000
          ACTUAL_BYTES=$(wc -c < pr.diff || echo 0)
          if [ "$ACTUAL_BYTES" -gt "$MAX_BYTES" ]; then
            head -c "$MAX_BYTES" pr.diff > pr_truncated.diff
            echo "::warning::Diff was too large ($ACTUAL_BYTES bytes). Truncated to $MAX_BYTES bytes."
            mv pr_truncated.diff pr.diff
          fi

          echo "Diff size:"
          wc -c pr.diff

      - name: Call OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
        run: |
          missing_secrets=()
          if [ -z "$OPENAI_API_KEY" ]; then
            missing_secrets+=("OPENAI_API_KEY")
          fi

          if [ -z "$OPENAI_PROJECT_ID" ]; then
            missing_secrets+=("OPENAI_PROJECT_ID")
          fi

          if [ "${#missing_secrets[@]}" -gt 0 ]; then
            echo "summary=Missing secret(s): ${missing_secrets[*]}." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Keep diff formatting (no flattening)
          DIFF_CONTENT=$(cat pr.diff)

          # Build prompt
          PROMPT="You are a PR summarizer for the Notoli project (Backend: Django; Frontend: React + MUI; Docker; GitHub Actions). Produce a high-level, human-readable digest of what changed and why it matters. Focus on intent, scope, behavior changes, and impact. Do NOT do a code review. Do NOT list line-by-line or file-by-file changes. Do NOT restate the diff. Be concise. If the diff is truncated, explicitly note that the summary may be incomplete. Your response MUST use the following exact sections, in order, each containing bullet points (or '(none)' if empty): ## ðŸ“Œ Summary (what & why): ## ðŸ“‚ Scope (what areas are affected): ## ðŸ”„ Behavior Changes (user-visible or API-visible): ## âš ï¸ Risk & Impact (what could break / who is affected): ## ðŸ”Ž Suggested Verification (quick checks): ## âž• Follow-ups (nice-to-do, not required for merge): Here is the diff: ${DIFF_CONTENT}"

          # Build JSON safely
          jq -n \
            --arg prompt "$PROMPT" \
            '
            {
              model: "gpt-5.1",
              temperature: 0.3,
              messages: [
                { "role": "system", "content": "You are an experienced PR summarizer helping on GitHub pull requests." },
                { "role": "user", "content": $prompt }
              ]
            }
            ' > body.json

          # Make API request (project is passed via header)
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Project: $OPENAI_PROJECT_ID" \
            --data @body.json)

          echo "Raw response:"
          echo "$RESPONSE"

          # Extract review text or error
          SUMMARY=$(echo "$RESPONSE" | jq -r '
            if .choices and .choices[0].message and .choices[0].message.content then
              .choices[0].message.content
            elif .error and .error.message then
              "OpenAI API error: " + .error.message
            else
              "OpenAI did not return a summary."
            end
          ')

          echo "Summary content:"
          echo "$SUMMARY"

          # Write multi-line output for GitHub Actions
          {
            echo 'summary<<EOF'
            printf '%s\n' "$SUMMARY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Update PR Description
        uses: actions/github-script@v8
        env:
          SUMMARY_BODY: ${{ steps.openai.outputs.summary }}
        with:
          script: |
            const body = process.env.SUMMARY_BODY;
            if (!body) {
              core.warning('Summary body is empty; skipping PR update.');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });

            const existingBody = (pr.body || '').trim();
            if (!existingBody || existingBody.startsWith('... ')) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body,
              });
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });

  pr-review:
    name: PR Review
    if: >
      github.event_name == 'issue_comment' &&
      github.event.action == 'created' &&
      github.event.sender.login == 'chatgpt-codex-connector' &&
      contains(github.event.comment.body, 'You have reached your Codex usage limits for code reviews.') &&
      github.event.issue.pull_request
    runs-on: ubuntu-latest

    steps:
      - name: Load PR data
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number,
            });

            core.setOutput('base_sha', pr.base.sha);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('pr_number', pr.number);

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.pr.outputs.head_ref }}

      - name: Get PR diff
        env:
          BASE_SHA: ${{ steps.pr.outputs.base_sha }}
          HEAD_SHA: ${{ steps.pr.outputs.head_sha }}
        run: |
          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"

          # Get unified diff between base and head
          git diff --unified=3 "$BASE_SHA" "$HEAD_SHA" > pr.diff

          # Truncate if it's huge so we don't blow up token limits
          MAX_BYTES=45000
          ACTUAL_BYTES=$(wc -c < pr.diff || echo 0)
          if [ "$ACTUAL_BYTES" -gt "$MAX_BYTES" ]; then
            head -c "$MAX_BYTES" pr.diff > pr_truncated.diff
            echo "::warning::Diff was too large ($ACTUAL_BYTES bytes). Truncated to $MAX_BYTES bytes."
            mv pr_truncated.diff pr.diff
          fi

          echo "Diff size:"
          wc -c pr.diff

      - name: Call OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "review=Missing OPENAI_API_KEY secret." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "$OPENAI_PROJECT_ID" ]; then
            echo "review=Missing OPENAI_PROJECT_ID secret." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Keep diff formatting (no flattening)
          DIFF_CONTENT=$(cat pr.diff)

          # Build prompt
          PROMPT="You are a senior engineer reviewing a pull request for the Notoli project. The tech stack is: Backend: Django; Frontend: React + Material UI; Environment: Conda; Deployment: Docker; CI/CD: GitHub Actions. Review the diff and give concise, brutally honest, actionable feedback. Your response MUST use the following exact sections, in order, each containing bullet points (or '(none)' if empty): ## ðŸ”´ Critical Issues (must fix before merge): ... ## ðŸŸ  Major Issues (should fix): ... ## ðŸŸ¡ Minor Issues (nice to fix): ... ## ðŸ”µ Suggestions & Improvements (optional): ... ## ðŸŸ£ Observations (non-actionable): ... Do NOT include anything outside these sections and do NOT restate the diff. Here is the diff: ${DIFF_CONTENT}"

          # Build JSON safely
          jq -n \
            --arg prompt "$PROMPT" \
            '
            {
              model: "gpt-5.1",
              temperature: 0.3,
              messages: [
                { "role": "system", "content": "You are an experienced code reviewer helping on GitHub pull requests." },
                { "role": "user", "content": $prompt }
              ]
            }
            ' > body.json

          # Make API request (project is passed via header)
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "OpenAI-Project: $OPENAI_PROJECT_ID" \
            --data @body.json)

          echo "Raw response:"
          echo "$RESPONSE"

          # Extract review text or error
          REVIEW=$(echo "$RESPONSE" | jq -r '
            if .choices and .choices[0].message and .choices[0].message.content then
              .choices[0].message.content
            elif .error and .error.message then
              "OpenAI API error: " + .error.message
            else
              "OpenAI did not return a review."
            end
          ')

          echo "Review content:"
          echo "$REVIEW"

          # Write multi-line output for GitHub Actions
          {
            echo 'review<<EOF'
            printf '%s\n' "$REVIEW"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Leave Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REVIEW_BODY: ${{ steps.openai.outputs.review }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
        run: |
          # Build the comment JSON safely with jq
          jq -n --arg body "$REVIEW_BODY" '{body: $body}' > comment.json

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments" \
            -d @comment.json
