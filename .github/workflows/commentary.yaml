name: Commentary

on:
  workflow_call:

concurrency:
  group: commentary-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-summary:
    name: ai-summary
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: pr_diff
        uses: ./.github/actions/get-pr-diff
        with:
          base_sha: ${{ github.event.pull_request.base.sha }}
          head_sha: ${{ github.event.pull_request.head.sha }}
          max_bytes: "45000"
      - name: Call OpenAI
        id: openai
        uses: ./.github/actions/openai-chat
        with:
          api_key: ${{ secrets.OPENAI_API_KEY }}
          project_id: ${{ secrets.OPENAI_PROJECT_ID }}
          diff_path: ${{ steps.pr_diff.outputs.diff_path }}
          model: "gpt-5.1"
          temperature: "0.3"
          system_prompt: "You are an experienced PR summarizer helping on GitHub pull requests."
          prompt_prefix: |
            You are a PR summarizer for the Notoli project (Backend: Django; Frontend: React + MUI; Docker; GitHub Actions). Produce a high-level, human-readable digest of what changed and why it matters. Focus on intent, scope, behavior changes, and impact. Do NOT do a code review. Do NOT list line-by-line or file-by-file changes. Do NOT restate the diff. Be concise. If the diff is truncated, explicitly note that the summary may be incomplete. Your response MUST use the following exact sections, in order, each containing bullet points (or '(none)' if empty): ## ðŸ“Œ Summary (what & why): ## ðŸ“‚ Scope (what areas are affected): ## ðŸ”„ Behavior Changes (user-visible or API-visible): Here is the diff:

      - name: Update PR Description
        uses: actions/github-script@v8
        env:
          SUMMARY_BODY: ${{ steps.openai.outputs.content }}
        with:
          script: |
            const body = process.env.SUMMARY_BODY;
            if (!body) {
              core.warning('Summary body is empty; skipping PR update.');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });

            const existingBody = (pr.body || '').trim();
            if (!existingBody || existingBody.startsWith('...')) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body,
              });
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });

  ai-review:
    name: ai-review
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Check for Codex usage limit comment
        id: codex_limit
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;
            const issue_number = pull_number;
            const limitPattern = /codex usage limits for code reviews/i;
            const isConnector = (login, type) => {
              const normalized = (login || '').toLowerCase();
              return (
                normalized.includes('chatgpt-codex-connector') ||
                normalized.includes('codex-connector') ||
                (type || '').toLowerCase() === 'bot'
              );
            };
            const isLimitHit = (login, type, body) =>
              isConnector(login, type) && limitPattern.test(body || '');
            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            const maxAttempts = 6;
            const delayMs = 20000;
            let hit = false;

            for (let attempt = 1; attempt <= maxAttempts && !hit; attempt += 1) {
              const [comments, reviews, reviewComments] = await Promise.all([
                github.paginate(github.rest.issues.listComments, {
                  owner,
                  repo,
                  issue_number,
                  per_page: 100,
                }),
                github.paginate(github.rest.pulls.listReviews, {
                  owner,
                  repo,
                  pull_number,
                  per_page: 100,
                }),
                github.paginate(github.rest.pulls.listReviewComments, {
                  owner,
                  repo,
                  pull_number,
                  per_page: 100,
                }),
              ]);

              const commentHit = comments.some((comment) =>
                isLimitHit(comment.user?.login, comment.user?.type, comment.body)
              );
              const reviewHit = reviews.some((review) =>
                isLimitHit(review.user?.login, review.user?.type, review.body)
              );
              const reviewCommentHit = reviewComments.some((comment) =>
                isLimitHit(comment.user?.login, comment.user?.type, comment.body)
              );

              hit = commentHit || reviewHit || reviewCommentHit;

              if (!hit && attempt < maxAttempts) {
                core.info(
                  `No Codex limit message yet. Waiting ${delayMs / 1000}s (attempt ${attempt}/${maxAttempts})...`
                );
                await sleep(delayMs);
              }
            }

            if (!hit) {
              core.info(
                'No Codex limit message found in issue comments, reviews, or review comments.'
              );
            }

            core.setOutput('limit_hit', hit ? 'true' : 'false');

      - name: Checkout PR
        if: steps.codex_limit.outputs.limit_hit == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get PR diff
        if: steps.codex_limit.outputs.limit_hit == 'true'
        id: pr_diff
        uses: ./.github/actions/get-pr-diff
        with:
          base_sha: ${{ github.event.pull_request.base.sha }}
          head_sha: ${{ github.event.pull_request.head.sha }}
          max_bytes: "45000"
      - name: Call OpenAI (Review)
        if: steps.codex_limit.outputs.limit_hit == 'true'
        id: openai_review
        uses: ./.github/actions/openai-chat
        with:
          api_key: ${{ secrets.OPENAI_API_KEY }}
          project_id: ${{ secrets.OPENAI_PROJECT_ID }}
          diff_path: ${{ steps.pr_diff.outputs.diff_path }}
          model: "gpt-5.1"
          temperature: "0.2"
          system_prompt: "You are an experienced, pragmatic PR reviewer."
          prompt_prefix: |
            You are a PR reviewer for the Notoli project (Backend: Django; Frontend: React + MUI; Docker; GitHub Actions). Provide a concise, high-signal code review focused on correctness, security, and maintainability risks. Flag potential bugs, edge cases, missing tests, or backwards-incompatible changes. Avoid style nitpicks. If you are unsure, say so. If the diff is truncated, explicitly note that the review may be incomplete. Use the following exact sections, in order, each containing bullet points (or '(none)' if empty): ## Review Summary: ## Issues & Suggestions: Here is the diff:

      - name: Comment PR Review
        if: steps.codex_limit.outputs.limit_hit == 'true'
        uses: actions/github-script@v8
        env:
          REVIEW_BODY: ${{ steps.openai_review.outputs.content }}
        with:
          script: |
            const body = process.env.REVIEW_BODY;
            if (!body) {
              core.warning('Review body is empty; skipping comment.');
              return;
            }

            const header = [
              'Codex limit reached for code reviews. Running custom code review:',
              '',
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `${header}${body}`,
            });


